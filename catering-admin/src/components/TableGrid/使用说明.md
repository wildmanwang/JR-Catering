# TablePlus 组件使用说明

## 概述

TablePlus 是一个 Excel 风格的可编辑表格组件，提供完整的单元格编辑、键盘导航、复制粘贴、行/列选择等功能。

### 核心特性

- **单元格编辑**：支持文本、数字、下拉选择、图片等类型
- **键盘导航**：Tab、方向键、Enter、Escape 等快捷键支持
- **复制粘贴**：支持单元格数据的复制和粘贴操作
- **行选择**：支持单选、Ctrl 多选、Shift 范围选择
- **行操作**：新增行、删除行（通过事件通知父组件）
- **列操作**：新增列、删除列（通过事件通知父组件）

### 设计原则

1. **数据流单向性**：组件不直接修改 `props.data` 和 `props.columns`，所有数据操作都通过事件通知父组件
2. **接口化操作**：所有表格操作都应该通过接口函数，避免直接操作内部状态
3. **事件驱动**：数据变更通过事件通知父组件处理

## Props

### TablePlusProps

| 属性 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| columns | TablePlusColumn[] | - | 列配置数组（必填） |
| data | any[] | - | 表格数据（必填） |
| currentRowIndex | number \| null | null | 当前行索引 |
| showDeleteButton | boolean | true | 是否显示删除按钮 |
| defaultRow | any | - | 默认行数据（用于新增行时） |

### TablePlusColumn

| 属性 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| field | string | - | 字段名（必填） |
| label | string | - | 列标题（必填） |
| width | string | - | 列宽度（如 '100px'） |
| minWidth | string | - | 最小列宽度 |
| show | boolean | true | 是否显示该列 |
| type | 'text' \| 'number' \| 'select' \| 'image' \| 'date' | 'text' | 数据类型 |
| size | 'normal' \| 'small' | 'small' | ImagePlus 组件尺寸（仅当 type='image' 时有效） |
| formatter | function | - | 自定义格式化函数 |
| options | Array<{label: string; value: any}> | - | 下拉选择选项（type='select' 时必填） |
| editable | boolean | true | 是否可编辑 |
| required | boolean | false | 是否必填 |
| selectProps | object | - | Element Plus Select 组件的属性（仅当 type='select' 时有效） |

## 事件

### row-add

新增行事件，当调用 `addRow()` 接口函数时触发。

**参数：** `payload: { defaultRow: any; insertIndex?: number }`

**说明：** 父组件需要监听此事件并实际添加数据到 `data` 数组。

### row-delete

删除行事件，当调用 `deleteRow()` 接口函数时触发。

**参数：** `rowIndex: number`

**说明：** 父组件需要监听此事件并实际删除数据。注意：`TablePlus` 内部会直接修改 `props.data` 并触发 `update:data` 事件。

### column-add

新增列事件，当调用 `addColumn()` 接口函数时触发。

**参数：** `payload: { field: string; colDefine: TablePlusColumn; insertIndex?: number }`

**说明：** 父组件需要监听此事件并实际添加列配置到 `columns` 数组。

### column-delete

删除列事件，当调用 `deleteColumn()` 接口函数时触发。

**参数：** `field: string`

**说明：** 父组件需要监听此事件并实际删除列配置。

### update:data

数据更新事件，当表格数据发生变化时触发。

**参数：** `data: any[]`

**说明：** 用于实现 `v-model:data` 双向绑定。

### update:currentRowIndex

当前行索引更新事件，当当前行索引发生变化时触发。

**参数：** `rowIndex: number | null`

**说明：** 用于实现 `v-model:currentRowIndex` 双向绑定。

### cell-click

单元格点击事件。

**参数：** `rowIndex: number, field: string, event: MouseEvent`

### cell-dblclick

单元格双击事件。

**参数：** `rowIndex: number, field: string, event: MouseEvent`

### cell-update

单元格数据更新事件。

**参数：** `rowIndex: number, field: string, value: any`

### image-update

图片字段更新事件。

**参数：** `rowIndex: number, field: string, value: any[]`

### cell-validate

单元格数据校验事件（可选）。

**参数：** `rowIndex: number, field: string, value: any`

**返回：** `boolean | string | null` - `true` 或 `null` 表示校验通过，`string` 表示校验失败的错误信息

## 接口函数

所有接口函数都通过 `defineExpose` 暴露，可以通过 `ref` 访问。

### 返回值格式

所有接口函数返回格式：`[code, message, ...extraData]`
- `code`: 1 表示成功，-1 表示失败
- `message`: 操作结果消息
- `extraData`: 额外的返回数据（如新增行的索引、新增列的索引等）

### 单元格操作接口

#### 1. selectCell(row, field)

选中指定单元格。

**参数：**
- `row`: number - 行索引，从0开始
- `field`: string - 字段名

**返回：** `[code, message]`

**示例：**
```typescript
const tableRef = ref<InstanceType<typeof TablePlus>>()
const [code, message] = tableRef.value?.selectCell(0, 'name') || []
if (code === 1) {
  console.log('选中成功')
}
```

#### 2. deselectCell(row?, field?)

退出单元格选中。

**参数：**
- `row`: number (可选) - 如果提供，只取消该行的单元格选中
- `field`: string (可选) - 如果提供，只取消该字段的单元格选中

**返回：** `[code, message]`

**说明：** 如果不提供参数，则取消所有单元格的选中。

#### 3. startEdit(row, field, options?)

进入编辑状态。

**参数：**
- `row`: number - 行索引，从0开始
- `field`: string - 字段名
- `options`: { isKeyboardInput?: boolean, inputValue?: string } (可选) - 编辑选项

**返回：** `[code, message]`

**说明：** 目标单元格必须先被选中，否则会返回错误。

#### 4. exitEdit(row, field, shouldValidate?)

退出编辑状态。

**参数：**
- `row`: number - 行索引，从0开始
- `field`: string - 字段名
- `shouldValidate`: boolean (可选) - 是否校验数据，默认 true

**返回：** `[code, message]`

#### 5. clearCurrentRow()

取消选中当前行和所有单元格。

**返回：** `[code, message]`

#### 6. navigateToCell(target, options?)

导航到目标单元格。

**参数：**
- `target`: 
  - `{ rowIndex: number, field: string }` - 精确单元格
  - `{ direction: 'up' | 'down' | 'left' | 'right' | 'tab' | 'enter', fromRowIndex?: number, fromField?: string }` - 相对位置
- `options`: { validateCurrent?: boolean, allowAddRow?: boolean } (可选)
  - `validateCurrent`: 是否校验当前编辑的单元格，默认 true
  - `allowAddRow`: 是否允许自动新增行（当目标行超出范围时），默认 true

**返回：** `[code, message]`

### 行操作接口

#### 7. selectRow(row, selectType?)

选中行。

**参数：**
- `row`: number - 行索引，从0开始
- `selectType`: 'single' | 'ctrl' | 'shift' (可选) - 选择模式，默认 'single'
  - `single`: 单选模式，取消其他已选中的行，选中目标行
  - `ctrl`: Ctrl 多选模式，目标行选择状态反转（已选中则取消，未选中则选中）
  - `shift`: Shift 范围选择模式，选中当前行与目标行之间的所有行

**返回：** `[code, message]`

#### 8. deselectRow(row?)

取消行选中。

**参数：**
- `row`: number (可选) - 如果提供，只取消该行的选中；如果不提供，取消所有行的选中

**返回：** `[code, message]`

#### 9. addRow(row?, defaultRow?)

新增行。

**参数：**
- `row`: number (可选) - 插入位置，从0开始。如果未提供或 row<0，则在末尾追加；如果 row>=0 且 <=最大行号，则在 row 前插入
- `defaultRow`: any (可选) - 默认行数据，如果未提供则使用 `props.defaultRow` 或列配置的默认值

**返回：** `[code, message, newRowIndex]`

**注意：** 
- 此函数会触发 `row-add` 事件，父组件需要监听该事件并实际添加数据
- 新增行后会自动选中新行

**示例：**
```vue
<TablePlus
  ref="tableRef"
  :default-row="getDefaultRow()"
  @row-add="handleRowAdd"
/>

<script setup>
const handleRowAdd = async (payload: { defaultRow: any; insertIndex?: number }) => {
  const { defaultRow, insertIndex } = payload
  const newRow = { ...getDefaultRow(), ...defaultRow }
  
  if (insertIndex === undefined || insertIndex < 0) {
    dataList.value.push(newRow)
  } else {
    dataList.value.splice(insertIndex, 0, newRow)
  }
  
  await nextTick()
}
</script>
```

#### 10. deleteRow(row)

删除行。

**参数：**
- `row`: number - 行索引，从0开始

**返回：** `[code, message]`

**注意：** 
- 此函数会在组件内部直接修改 `props.data` 并触发 `update:data` 事件
- 删除行时会自动取消所有行的选中状态

**示例：**
```vue
<TablePlus
  ref="tableRef"
  @update:data="handleDataUpdate"
/>

<script setup>
const handleDataUpdate = (newData: any[]) => {
  dataList.value = newData
  // 同步更新 originalData 等逻辑
}
</script>
```

### 列操作接口

#### 11. addColumn(field, colDefine, insertIndex?)

新增列。

**参数：**
- `field`: string - 字段名
- `colDefine`: TablePlusColumn - 列定义对象
- `insertIndex`: number (可选) - 插入位置，从0开始

**返回：** `[code, message, newColIndex]`

**注意：** 此函数会触发 `column-add` 事件，父组件需要监听该事件并实际添加列配置。

#### 12. deleteColumn(field)

删除列。

**参数：**
- `field`: string - 字段名

**返回：** `[code, message]`

**注意：** 此函数会触发 `column-delete` 事件，父组件需要监听该事件并实际删除列配置。

### 其他接口

#### 13. setCurrentRow(rowIndex)

设置当前行。

**参数：**
- `rowIndex`: number | null - 行索引，从0开始，null 表示清除当前行

**返回：** `[code, message]`

#### 14. uploadRowImageField(rowIndex, field)

上传指定行的图片字段。

**参数：**
- `rowIndex`: number - 行索引，从0开始
- `field`: string - 字段名

**返回：** Promise<void>

## 使用示例

### 基本使用

```vue
<template>
  <TablePlus
    ref="tableRef"
    :columns="columns"
    :data="dataList"
    v-model:currentRowIndex="currentRowIndex"
    :default-row="getDefaultRow()"
    @row-add="handleRowAdd"
    @update:data="handleDataUpdate"
  />
</template>

<script setup lang="ts">
import { ref } from 'vue'
import TablePlus, { type TablePlusColumn } from '@/components/TablePlus'

const tableRef = ref<InstanceType<typeof TablePlus>>()
const dataList = ref<any[]>([])
const currentRowIndex = ref<number | null>(null)

const columns: TablePlusColumn[] = [
  { field: 'name', label: '名称', type: 'text' },
  { field: 'price', label: '价格', type: 'number' },
  { 
    field: 'status', 
    label: '状态', 
    type: 'select',
    options: [
      { label: '启用', value: 1 },
      { label: '禁用', value: 0 }
    ],
    value: 1  // 默认值
  }
]

const getDefaultRow = () => ({
  name: '',
  price: 0,
  status: 1
})

// 处理新增行
const handleRowAdd = async (payload: { defaultRow: any; insertIndex?: number }) => {
  const { defaultRow, insertIndex } = payload
  const newRow = { ...getDefaultRow(), ...defaultRow }
  
  if (insertIndex === undefined || insertIndex < 0) {
    dataList.value.push(newRow)
  } else {
    dataList.value.splice(insertIndex, 0, newRow)
  }
  
  await nextTick()
}

// 处理数据更新
const handleDataUpdate = (newData: any[]) => {
  dataList.value = newData
}

// 通过接口函数操作表格
const addNewRow = async () => {
  const [code, message, newRowIndex] = await tableRef.value?.addRow() || []
  if (code === 1) {
    console.log(`新增行成功，索引：${newRowIndex}`)
  }
}

const selectFirstCell = () => {
  const [code, message] = tableRef.value?.selectCell(0, 'name') || []
  if (code === 1) {
    console.log('选中成功')
  }
}
</script>
```

### 键盘导航

组件内置了完整的键盘导航支持：

- **Tab / Shift+Tab**: 向右/向左移动到下一个可编辑单元格
- **方向键**: 上下左右移动
- **Enter**: 进入编辑状态（非编辑状态下）
- **Escape**: 退出编辑状态（编辑状态下）
- **Ctrl+C**: 复制单元格数据
- **Ctrl+V**: 粘贴数据到单元格

### 行选择操作

- **单击序号列**: 单选模式，选中该行
- **Ctrl+单击序号列**: 多选模式，切换该行的选中状态
- **Shift+单击序号列**: 范围选择模式，选中从上次选中行到当前行的所有行

## 注意事项

1. **数据流单向性**：组件不直接修改 `props.data` 和 `props.columns`，所有数据操作都通过事件通知父组件（删除行除外，会直接修改 `props.data`）

2. **接口函数调用**：所有表格操作都应该通过接口函数，避免直接操作内部状态

3. **事件处理**：新增/删除行/列操作需要父组件监听相应事件并实际执行数据操作

4. **返回值处理**：接口函数返回 `[code, message]` 格式，需要检查 `code` 判断操作是否成功

5. **默认值设置**：
   - 列配置中的 `value` 属性会被 `getDefaultRow()` 正确读取
   - `props.defaultRow` 优先级高于列配置的 `value`
   - 传入 `addRow()` 的 `defaultRow` 参数优先级最高
   - 对于 `select` 类型，避免在组件内部设置空字符串，以免覆盖有效的默认值

6. **图片字段处理**：图片字段使用 `ImagePlus` 组件，支持拖拽排序、上传、删除等功能

7. **下拉选择**：双击 `select` 类型的单元格会自动打开下拉框

8. **单元格校验**：可以通过 `cell-validate` 事件实现自定义校验逻辑
