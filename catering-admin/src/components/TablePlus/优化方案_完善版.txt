TablePlus组件优化方案（完善版）
========================================

【说明】
1. 以"fun_"开头代表调用预定义的函数（内部函数或接口函数）；
2. row代表数据单元格的行号，从0开始（数组索引），不包括标题行；
3. col代表数据单元格的列号，使用field（字段名）标识，不包括序号列和action列；
4. 所有接口函数返回格式：[code, message]，code=1表示成功，code=-1表示失败；
5. 所有接口函数都应该通过defineExpose暴露，避免外部直接操作内部状态；

【当前实现分析】
- 已有函数：startEdit, endEdit, exitEditMode, deselectCell, deselectRow, selectCell, selectRow, navigateToCell, handleDeleteRow, setCurrentRow
- 新增行：通过emit('row-add')事件，由父组件处理
- 列操作：目前未实现

【接口函数设计】

【1. 选中单元格(row, field)】
接口名：selectCell
参数：
  - row: number (行索引，从0开始)
  - field: string (字段名)
返回：[code, message]
逻辑：
  - 如果row小于0或row大于等于最大行号，则：return [-1, "行号row无效"]
  - 如果field无效（不存在或不可编辑），则：return [-1, "列field无效"]
  - fun_退出编辑(当前编辑的单元格) - 如果失败则return失败信息
  - fun_取消单元格选中()
  - fun_取消行选择()
  - 选中目标单元格（设置DOM样式，获得焦点）
  - 设置当前行为row
  - return [1, "就绪"]
实现：
  - 可以基于现有的navigateToCell函数实现
  - navigateToCell({ rowIndex: row, field }, { validateCurrent: false, allowAddRow: false })

【2. 退出单元格选中(row, field)】
接口名：deselectCell
参数：
  - row?: number (可选，用于校验)
  - field?: string (可选，用于校验)
返回：[code, message]
逻辑：
  - 如果提供了row和field，校验当前选中单元格是否匹配
  - fun_退出编辑(当前编辑的单元格) - 不校验，不选中
  - 清除单元格选中状态（移除DOM样式，失去焦点）
  - return [1, "就绪"]
实现：
  - 基于现有的deselectCell函数，但需要添加参数校验

【3. 进入编辑(row, field)】
接口名：startEdit
参数：
  - row: number (行索引，从0开始)
  - field: string (字段名)
  - options?: { isKeyboardInput?: boolean, inputValue?: string } (可选)
返回：[code, message]
逻辑：
  - 如果row小于0或row大于等于最大行号，则：return [-1, "行号row无效"]
  - 如果field无效（不存在或不可编辑），则：return [-1, "列field无效"]
  - 如果当前选中单元格与(row, field)不一致，则：return [-1, "目标单元格未选中"]
  - 如果目标单元格类型为image，则：return [-1, "图片列不支持编辑"]
  - 目标单元格进入编辑状态（设置editingCell状态）
  - 定位光标（文本类型定位在文本末尾，数字类型选中文本）
  - return [1, "就绪"]
实现：
  - 基于现有的startEdit函数，但需要添加参数校验和返回值

【4. 退出编辑(row, field, shouldValidate)】
接口名：exitEdit
参数：
  - row: number (行索引，从0开始)
  - field: string (字段名)
  - shouldValidate?: boolean (是否校验，默认true)
返回：[code, message]
逻辑：
  - 如果当前没有单元格处于编辑状态，则：return [1, "就绪"]
  - 如果row小于0或row大于等于最大行号，则：return [-1, "行号row无效"]
  - 如果field无效（不存在），则：return [-1, "列field无效"]
  - 如果当前编辑单元格与(row, field)不一致，则：return [-1, "目标单元格与编辑单元格不一致"]
  - 如果shouldValidate为true，校验数据，校验失败则：return [-1, <校验失败的错误信息>]
  - 目标单元格退出编辑状态（清除editingCell状态）
  - 目标单元格进入选中状态（设置DOM样式，获得焦点）
  - return [1, "就绪"]
实现：
  - 基于现有的exitEditMode函数，但需要添加参数校验和返回值
  - exitEditMode(shouldValidate, true) - true表示退出后选中单元格

【5. 取消选中当前行】
接口名：clearCurrentRow
参数：无
返回：[code, message]
逻辑：
  - fun_退出单元格选中()，失败则：return [-1, <失败的错误信息>]
  - 设置当前行为null
  - return [1, "就绪"]
实现：
  - 调用deselectCell()
  - 调用setCurrentRow(null)

【6. 选中行(row, selectType)】
接口名：selectRow
参数：
  - row: number (行索引，从0开始)
  - selectType?: 'single' | 'ctrl' | 'shift' (选择模式，默认'single')
返回：[code, message]
逻辑：
  - 如果row小于0或row大于等于最大行号，则：return [-1, "行号row无效"]
  - 如果目标行等于当前行且是单选模式，则：return [row, "就绪"]
  - fun_退出单元格选中()
  - 如果是单选模式，取消已选中的所有行，选中目标行
  - 如果是ctrl模式，目标行选择状态反转（已选中则取消，未选中则选中）
  - 如果是shift模式，选中当前行与目标行之间的所有行，取消选择其他已选中行
  - 设置当前行为目标行（ctrl模式下如果目标行被选中才设置）
  - return [1, "就绪"]
实现：
  - 基于现有的selectRow函数，但需要添加返回值

【7. 新增行(row, defaultRow)】
接口名：addRow
参数：
  - row?: number (插入位置，从0开始。如果未提供或row<0，则在末尾追加；如果row>=0且<=最大行号，则在row前插入)
  - defaultRow?: any (默认行数据，如果未提供则使用列配置的默认值)
返回：[code, message, newRowIndex]
逻辑：
  - fun_取消选中当前行()，失败则：return [-1, <失败的错误信息>]
  - 如果row未提供或row<0，则在末尾追加新行
  - 如果row>=0且row<=最大行号，则在row前插入新行
  - 如果row>最大行号，则：return [-1, "行号row无效"]
  - 创建默认行数据（合并列配置的默认值和defaultRow参数）
  - 触发'row-add'事件，传递defaultRow和插入位置信息
  - 等待父组件处理（通过nextTick）
  - fun_选中行(新增行的行号)
  - return [1, "就绪", newRowIndex]
注意：
  - 新增行操作通过emit('row-add')事件通知父组件，由父组件实际添加数据
  - 组件内部不直接操作props.data，保持数据流的单向性
实现：
  - 需要新增addRow接口函数
  - 内部调用clearCurrentRow()
  - emit('row-add', { defaultRow, insertIndex: row })
  - 等待nextTick后调用selectRow(newRowIndex)

【8. 删除行(row)】
接口名：deleteRow
参数：
  - row: number (行索引，从0开始)
返回：[code, message]
逻辑：
  - 如果row无效（小于0或大于等于最大行号），则：return [-1, "行号row无效"]
  - fun_取消选中当前行()，失败则：return [-1, <失败的错误信息>]
  - 如果删除的行是当前行，清除选中状态
  - 如果删除的行在当前行之前，更新当前行索引（减1）
  - 如果删除的行正在编辑，结束编辑状态
  - 触发'row-delete'事件，传递row
  - 等待父组件处理（通过nextTick）
  - return [1, "就绪"]
注意：
  - 删除行操作通过emit('row-delete')事件通知父组件，由父组件实际删除数据
  - 组件内部不直接操作props.data，保持数据流的单向性
实现：
  - 基于现有的handleDeleteRow函数，但需要改为接口函数并添加返回值
  - 内部调用clearCurrentRow()
  - emit('row-delete', row)
  - 处理当前行索引的更新逻辑

【9. 新增列(field, colDefine, insertIndex)】
接口名：addColumn
参数：
  - field: string (字段名)
  - colDefine: TablePlusColumn (列定义对象)
  - insertIndex?: number (插入位置，从0开始。如果未提供或insertIndex<0，则在末尾追加；如果insertIndex>=0且<=最大列号，则在insertIndex前插入)
返回：[code, message, newColIndex]
逻辑：
  - 如果field无效（空字符串或已存在），则：return [-1, "字段名field无效"]
  - 如果colDefine无效（不是对象或缺少必要属性），则：return [-1, "列定义colDefine无效"]
  - fun_退出单元格选中()，失败则：return [-1, <失败的错误信息>]
  - 如果insertIndex未提供或insertIndex<0，则在末尾追加新列
  - 如果insertIndex>=0且insertIndex<=最大列号，则在insertIndex前插入新列
  - 如果insertIndex>最大列号，则：return [-1, "列号insertIndex无效"]
  - 触发'column-add'事件，传递field、colDefine和insertIndex
  - 等待父组件处理（通过nextTick）
  - return [1, "就绪", newColIndex]
注意：
  - 新增列操作通过emit('column-add')事件通知父组件，由父组件实际添加列配置
  - 组件内部不直接操作props.columns，保持数据流的单向性
实现：
  - 需要新增addColumn接口函数
  - 内部调用deselectCell()
  - emit('column-add', { field, colDefine, insertIndex })

【10. 删除列(field)】
接口名：deleteColumn
参数：
  - field: string (字段名)
返回：[code, message]
逻辑：
  - 如果field无效（不存在），则：return [-1, "字段名field无效"]
  - fun_退出单元格选中()，失败则：return [-1, <失败的错误信息>]
  - 如果删除的列是当前选中单元格的列，清除选中状态
  - 触发'column-delete'事件，传递field
  - 等待父组件处理（通过nextTick）
  - return [1, "就绪"]
注意：
  - 删除列操作通过emit('column-delete')事件通知父组件，由父组件实际删除列配置
  - 组件内部不直接操作props.columns，保持数据流的单向性
实现：
  - 需要新增deleteColumn接口函数
  - 内部调用deselectCell()
  - emit('column-delete', field)

【11. 导航到单元格(target, options)】
接口名：navigateToCell
参数：
  - target: { rowIndex: number, field: string } | { direction: 'up' | 'down' | 'left' | 'right' | 'tab' | 'enter', fromRowIndex?: number, fromField?: string }
  - options?: { validateCurrent?: boolean, allowAddRow?: boolean }
返回：[code, message]
逻辑：
  - 计算目标单元格位置（通过calculateTargetCell函数）
  - 如果目标单元格无效，则：return [-1, "目标单元格无效"]
  - fun_退出编辑(当前编辑的单元格) - 根据options.validateCurrent决定是否校验
  - 如果目标单元格行号大于最大行号且allowAddRow为true，则：fun_新增行(目标行号)
  - fun_选中单元格(目标单元格row, field)
  - return [1, "就绪"]
实现：
  - 基于现有的navigateToCell函数，但需要添加返回值

【内部辅助函数（不暴露）】
- calculateTargetCell: 计算目标单元格位置（已存在）
- applyCellSelection: 应用单元格选中状态（已存在）
- getEditableFields: 获取可编辑字段列表（已存在）
- validateCell: 校验单元格数据（已存在）
- formatCellValue: 格式化单元格显示值（已存在）
- setCursorPosition: 设置光标位置（已存在）
- openSelectDropdown: 打开下拉框（已存在）

【事件定义（emit）】
- 'row-add': (payload: { defaultRow: any, insertIndex?: number }) => void
- 'row-delete': (rowIndex: number) => void
- 'column-add': (payload: { field: string, colDefine: TablePlusColumn, insertIndex?: number }) => void
- 'column-delete': (field: string) => void
- 'update:data': (data: any[]) => void
- 'update:currentRowIndex': (rowIndex: number | null) => void
- 'cell-click': (rowIndex: number, field: string, event: MouseEvent) => void
- 'cell-dblclick': (rowIndex: number, field: string, event: MouseEvent) => void
- 'cell-update': (rowIndex: number, field: string, value: any) => void
- 'image-update': (rowIndex: number, field: string, value: any[]) => void
- 'cell-validate': (rowIndex: number, field: string, value: any) => boolean | string | null

【应用场景】

【键盘导航】
- Tab/Shift+Tab：fun_导航到单元格({ direction: 'right'/'left' }, { validateCurrent: true, allowAddRow: true })
- 方向键：fun_导航到单元格({ direction: 'up'/'down'/'left'/'right' }, { validateCurrent: false, allowAddRow: true })
- Enter：非编辑状态下：fun_进入编辑(当前行, 当前列)；编辑状态下不响应（由输入框处理）
- Esc：编辑状态下：fun_退出编辑(当前编辑的行, 当前编辑的列, false)；非编辑状态不响应

【鼠标操作】
- 单击单元格：fun_选中单元格(row, field)
- 双击单元格：fun_进入编辑(row, field)
- 单击序号列：fun_选中行(row, 'single')
- Ctrl+单击序号列：fun_选中行(row, 'ctrl')
- Shift+单击序号列：fun_选中行(row, 'shift')
- 单击删除按钮：fun_删除行(row)

【工具栏操作】
- 新增行按钮：fun_新增行(undefined, undefined) - 在末尾追加
- 删除行按钮：fun_删除行(当前行)

【递归引用检查】
1. selectCell -> navigateToCell -> exitEditMode -> deselectCell ✓ (无循环)
2. selectRow -> deselectCell -> exitEditMode ✓ (无循环)
3. addRow -> clearCurrentRow -> deselectCell -> exitEditMode ✓ (无循环)
4. deleteRow -> clearCurrentRow -> deselectCell -> exitEditMode ✓ (无循环)
5. navigateToCell -> exitEditMode -> deselectCell ✓ (无循环)
6. navigateToCell -> addRow -> clearCurrentRow -> deselectCell ✓ (无循环)
7. exitEdit -> exitEditMode ✓ (无循环)

结论：所有函数调用链都是单向的，不存在递归引用。

【注意事项】
1. 所有接口函数都应该通过defineExpose暴露
2. 所有数据操作（新增/删除行/列）都通过emit事件通知父组件，保持数据流的单向性
3. 参数统一使用row（从0开始的行索引）和field（字段名）
4. 返回值统一格式：[code, message, ...extraData]
5. 内部状态（editingCell, selectedRowIndex等）不应该被外部直接访问
6. DOM操作应该封装在组件内部，外部只通过接口函数操作
7. 事件处理应该调用接口函数，而不是直接操作内部状态

【待实现功能】
1. 新增addRow接口函数
2. 新增deleteRow接口函数（基于handleDeleteRow改造）
3. 新增addColumn接口函数
4. 新增deleteColumn接口函数
5. 完善所有接口函数的参数校验和返回值
6. 统一事件处理逻辑，确保都通过接口函数调用
7. 添加'column-add'和'column-delete'事件定义

