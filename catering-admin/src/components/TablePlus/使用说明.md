# TablePlus 组件使用说明

## 概述

TablePlus 是一个可编辑表格组件，支持 Excel 风格的编辑体验，包括单元格编辑、键盘导航、复制粘贴、行/列操作等功能。

## 接口函数

所有接口函数都通过 `defineExpose` 暴露，可以通过 `ref` 访问。

### 返回值格式

所有接口函数返回格式：`[code, message, ...extraData]`
- `code`: 1 表示成功，-1 表示失败
- `message`: 操作结果消息
- `extraData`: 额外的返回数据（如新增行的索引、新增列的索引等）

### 单元格操作接口

#### 1. selectCell(row, field)
选中指定单元格

**参数：**
- `row`: number - 行索引，从0开始
- `field`: string - 字段名

**返回：** `[code, message]`

**示例：**
```typescript
const tableRef = ref<InstanceType<typeof TablePlus>>()
const [code, message] = tableRef.value?.selectCell(0, 'name') || []
if (code === 1) {
  console.log('选中成功')
}
```

#### 2. deselectCell(row?, field?)
退出单元格选中

**参数：**
- `row`: number (可选) - 用于校验当前选中单元格的行号
- `field`: string (可选) - 用于校验当前选中单元格的字段名

**返回：** `[code, message]`

#### 3. startEdit(row, field, options?)
进入编辑状态

**参数：**
- `row`: number - 行索引，从0开始
- `field`: string - 字段名
- `options`: { isKeyboardInput?: boolean, inputValue?: string } (可选) - 编辑选项

**返回：** `[code, message]`

#### 4. exitEdit(row, field, shouldValidate?)
退出编辑状态

**参数：**
- `row`: number - 行索引，从0开始
- `field`: string - 字段名
- `shouldValidate`: boolean (可选) - 是否校验数据，默认true

**返回：** `[code, message]`

#### 5. clearCurrentRow()
取消选中当前行

**返回：** `[code, message]`

#### 6. navigateToCell(target, options?)
导航到目标单元格

**参数：**
- `target`: 
  - `{ rowIndex: number, field: string }` - 精确单元格
  - `{ direction: 'up' | 'down' | 'left' | 'right' | 'tab' | 'enter', fromRowIndex?: number, fromField?: string }` - 相对位置
- `options`: { validateCurrent?: boolean, allowAddRow?: boolean } (可选)

**返回：** `[code, message]`

### 行操作接口

#### 7. selectRow(row, selectType?)
选中行

**参数：**
- `row`: number - 行索引，从0开始
- `selectType`: 'single' | 'ctrl' | 'shift' (可选) - 选择模式，默认'single'

**返回：** `[code, message]`

#### 8. addRow(row?, defaultRow?)
新增行

**参数：**
- `row`: number (可选) - 插入位置，从0开始。如果未提供或row<0，则在末尾追加；如果row>=0且<=最大行号，则在row前插入
- `defaultRow`: any (可选) - 默认行数据，如果未提供则使用列配置的默认值

**返回：** `[code, message, newRowIndex]`

**注意：** 此函数会触发 `row-add` 事件，父组件需要监听该事件并实际添加数据。

**示例：**
```vue
<TablePlus
  ref="tableRef"
  @row-add="handleRowAdd"
/>

<script setup>
const handleRowAdd = async (payload: { defaultRow: any; insertIndex?: number }) => {
  const { defaultRow, insertIndex } = payload
  const newRow = { ...getDefaultRow(), ...defaultRow }
  
  if (insertIndex === undefined || insertIndex < 0) {
    dataList.value.push(newRow)
  } else {
    dataList.value.splice(insertIndex, 0, newRow)
  }
  
  await nextTick()
  // 切换当前行到新行
  currentRowIndex.value = insertIndex ?? dataList.value.length - 1
}
</script>
```

#### 9. deleteRow(row)
删除行

**参数：**
- `row`: number - 行索引，从0开始

**返回：** `[code, message]`

**注意：** 此函数会触发 `row-delete` 事件，父组件需要监听该事件并实际删除数据。

**示例：**
```vue
<TablePlus
  ref="tableRef"
  @row-delete="handleRowDelete"
/>

<script setup>
const handleRowDelete = (rowIndex: number) => {
  dataList.value.splice(rowIndex, 1)
  // 更新当前行索引等逻辑
}
</script>
```

### 列操作接口

#### 10. addColumn(field, colDefine, insertIndex?)
新增列

**参数：**
- `field`: string - 字段名
- `colDefine`: TablePlusColumn - 列定义对象
- `insertIndex`: number (可选) - 插入位置，从0开始

**返回：** `[code, message, newColIndex]`

**注意：** 此函数会触发 `column-add` 事件，父组件需要监听该事件并实际添加列配置。

#### 11. deleteColumn(field)
删除列

**参数：**
- `field`: string - 字段名

**返回：** `[code, message]`

**注意：** 此函数会触发 `column-delete` 事件，父组件需要监听该事件并实际删除列配置。

### 其他接口

#### 12. setCurrentRow(rowIndex)
设置当前行

**参数：**
- `rowIndex`: number | null - 行索引，从0开始，null表示清除当前行

**返回：** void

#### 13. uploadRowImageField(rowIndex, field)
上传指定行的图片字段

**参数：**
- `rowIndex`: number - 行索引，从0开始
- `field`: string - 字段名

**返回：** Promise<void>

## 事件

### row-add
新增行事件

**参数：** `payload: { defaultRow: any; insertIndex?: number }`

**说明：** 当需要新增行时触发，父组件需要监听此事件并实际添加数据。

### row-delete
删除行事件

**参数：** `rowIndex: number`

**说明：** 当需要删除行时触发，父组件需要监听此事件并实际删除数据。

### column-add
新增列事件

**参数：** `payload: { field: string; colDefine: TablePlusColumn; insertIndex?: number }`

**说明：** 当需要新增列时触发，父组件需要监听此事件并实际添加列配置。

### column-delete
删除列事件

**参数：** `field: string`

**说明：** 当需要删除列时触发，父组件需要监听此事件并实际删除列配置。

### update:data
数据更新事件

**参数：** `data: any[]`

**说明：** 当表格数据发生变化时触发。

### update:currentRowIndex
当前行索引更新事件

**参数：** `rowIndex: number | null`

**说明：** 当当前行索引发生变化时触发。

## 使用示例

### 基本使用

```vue
<template>
  <TablePlus
    ref="tableRef"
    :columns="columns"
    :data="dataList"
    v-model:currentRowIndex="currentRowIndex"
    @row-add="handleRowAdd"
    @row-delete="handleRowDelete"
    @update:data="handleDataUpdate"
  />
</template>

<script setup lang="ts">
import { ref } from 'vue'
import TablePlus, { type TablePlusColumn } from '@/components/TablePlus'

const tableRef = ref<InstanceType<typeof TablePlus>>()
const dataList = ref<any[]>([])
const currentRowIndex = ref<number | null>(null)

const columns: TablePlusColumn[] = [
  { field: 'name', label: '名称', type: 'text' },
  { field: 'price', label: '价格', type: 'number' }
]

// 处理新增行
const handleRowAdd = async (payload: { defaultRow: any; insertIndex?: number }) => {
  const { defaultRow, insertIndex } = payload
  const newRow = { ...defaultRow }
  
  if (insertIndex === undefined || insertIndex < 0) {
    dataList.value.push(newRow)
  } else {
    dataList.value.splice(insertIndex, 0, newRow)
  }
  
  await nextTick()
  currentRowIndex.value = insertIndex ?? dataList.value.length - 1
}

// 处理删除行
const handleRowDelete = (rowIndex: number) => {
  dataList.value.splice(rowIndex, 1)
  if (currentRowIndex.value === rowIndex) {
    currentRowIndex.value = null
  } else if (currentRowIndex.value !== null && currentRowIndex.value > rowIndex) {
    currentRowIndex.value--
  }
}

// 处理数据更新
const handleDataUpdate = (newData: any[]) => {
  dataList.value = newData
}

// 通过接口函数操作表格
const addNewRow = async () => {
  const [code, message, newRowIndex] = await tableRef.value?.addRow() || []
  if (code === 1) {
    console.log(`新增行成功，索引：${newRowIndex}`)
  }
}

const selectFirstCell = () => {
  const [code, message] = tableRef.value?.selectCell(0, 'name') || []
  if (code === 1) {
    console.log('选中成功')
  }
}
</script>
```

## 注意事项

1. **数据流单向性**：组件不直接修改 `props.data` 和 `props.columns`，所有数据操作都通过事件通知父组件
2. **接口函数调用**：所有表格操作都应该通过接口函数，避免直接操作内部状态
3. **事件处理**：新增/删除行/列操作需要父组件监听相应事件并实际执行数据操作
4. **返回值处理**：接口函数返回 `[code, message]` 格式，需要检查 `code` 判断操作是否成功

